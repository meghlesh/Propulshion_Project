{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Manage Services | Propulsion Technology</title>
  <link rel="icon" type="image/png" href="{% static 'img/logo.png'%}">
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    /* ensure emoji-capable fonts are available for preview & inputs */
    .emoji-font {
      font-family: "Segoe UI Emoji", "Apple Color Emoji", "Noto Color Emoji", "Segoe UI Symbol", system-ui, sans-serif;
      /* slightly larger so emoji look nice */
      font-size: 1.4rem;
      line-height: 1;
      vertical-align: middle;
    }

    /* small styling to position preview next to input */
    .icon-preview {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      min-width: 38px;
      min-height: 38px;
      margin-left: 0.5rem;
      border-radius: 0.5rem;
      background: rgba(5,56,48,0.03);
      border: 1px solid rgba(5,56,48,0.06);
      padding: 4px;
    }

    /* small helper for hidden visually but accessible */
    .sr-only { position: absolute !important; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0,0,0,0); white-space: nowrap; border: 0; }
  </style>
</head>
<body class="bg-[#EAF4E0] font-sans text-[#053830]">

<!-- Blur Loader -->
<div id="blur-loader"
     class="fixed inset-0 flex items-center justify-center bg-white/60 backdrop-blur-md z-[9999] hidden">
    <div class="w-16 h-16 border-4 border-[#053830] border-t-transparent rounded-full animate-spin"></div>
</div>

  <!-- Navbar -->
  <nav class="bg-[#053830] text-white p-5 flex justify-between items-center shadow-lg">
    <h1 class="text-2xl font-bold">Manage Services</h1>
    <div>
      <a href="{% url 'home' %}" class="text-[#FF9728] font-semibold hover:text-[#FFB857] mr-6 transition">Back To Home</a>
      <a href="{% url 'admin_dashboard' %}" class="text-[#FF9728] font-semibold hover:text-[#FFB857] mr-6">Dashboard</a>
      <a href="{% url 'admin_logout' %}" class="bg-[#FF9728] text-[#053830] px-5 py-1.5 rounded-xl font-semibold hover:bg-[#FFB857] transition">Logout</a>
    </div>
  </nav>

  <main class="max-w-6xl mx-auto mt-10 p-6 bg-white rounded-3xl shadow-2xl">
    <h2 class="text-3xl font-extrabold mb-6 text-center text-[#053830]">Service Inventory</h2>

    {% if messages %}
      {% for message in messages %}
        {% if "deleted" in message.message|lower %}
          <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-xl shadow-md mb-6" role="alert">
             {{ message }}
          </div>
        {% else %}
          <div class="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded-xl shadow-md mb-6" role="alert">
              âœ… {{ message }}
          </div>
        {% endif %}
      {% endfor %}
    {% endif %}

    <!-- Service Table Container -->
    <div class="mb-6">
      <div class="overflow-x-auto">
        <table class="min-w-full border border-gray-200 rounded-xl overflow-hidden shadow-lg">
          <thead class="bg-[#053830] text-white">
            <tr>
              <th class="px-6 py-3 text-left">Title</th>
              <th class="px-6 py-3 text-left">Description</th>
              <th class="px-6 py-3 text-left">Color</th>
              <th class="px-6 py-3 text-left">Order</th>
              <th class="px-6 py-3 text-center">Actions</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-gray-200" id="service-list">
            {% for service in services %}
              <tr class="hover:bg-[#F7FBF5] transition-all {% if forloop.counter > 5 %}hidden-service hidden{% endif %}">
                <td class="px-6 py-3 font-semibold">{{ service.title }}</td>
                <td class="px-6 py-3">{{ service.description|truncatechars:60 }}</td>
                <td class="px-6 py-3">{{ service.color }}</td>
                <td class="px-6 py-3">{{ service.order }}</td>
                <td class="px-6 py-3 text-center">
                  <div class="flex items-center justify-center space-x-2 whitespace-nowrap">
                    <a href="{% url 'edit_service' service.id %}" class="text-blue-600 hover:text-blue-800 font-semibold transition-colors">Edit</a>
                    <span class="text-gray-300">|</span>
                    <a href="{% url 'delete_service' service.id %}" class="text-red-600 hover:text-red-800 font-semibold transition-colors">Delete</a>
                  </div>
                </td>
              </tr>
            {% empty %}
              <tr>
                <td colspan="5" class="text-center py-6 text-gray-500">No services found yet.</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      {% if services|length > 5 %}
        <div id="toggle-container" class="text-center mt-6">
          <button id="toggle-services-btn" type="button"
              class="text-white bg-[#053830] px-6 py-2 rounded-xl font-semibold hover:bg-[#FF9728] hover:text-[#053830] transition-all shadow-lg transform hover:scale-[1.02]">
            Show All {{ services|length }} Services ({{ services|length|add:"-5" }} hidden)
          </button>
        </div>
      {% endif %}
    </div>

    <!-- Add New Service Form -->
    <div class="bg-[#EAF4E0] p-8 rounded-2xl shadow-inner mt-8">
      <h3 class="text-2xl font-bold mb-6 text-[#053830]">Add New Service</h3>

      <form method="POST" enctype="multipart/form-data" class="space-y-6" id="add-service-form">
        {% csrf_token %}

        <div class="grid md:grid-cols-2 gap-6">
          <!-- Title -->
          <div>
            <label for="title" class="block font-semibold mb-2">Title</label>
            <input type="text" id="title" name="title" maxlength="50" required
                   value="{{ form_values.title|default:'' }}"
                   class="w-full border border-gray-300 rounded-xl px-4 py-2 focus:ring-2 focus:ring-[#053830] focus:border-[#053830] transition-all">
            <p id="titleCount" class="text-sm text-gray-500 mt-1">0 / 50</p>
          </div>

          <!-- Color -->
          <div>
            <label for="color" class="block font-semibold mb-2">Color</label>
            <select id="color" name="color" required
                    class="w-full border border-gray-300 rounded-xl px-4 py-2 focus:ring-2 focus:ring-[#053830] focus:border-[#053830] transition-all">
              <option value="accent-green" {% if form_values.color == 'accent-green' %}selected{% endif %}>Accent Green</option>
              <option value="highlight-gold" {% if form_values.color == 'highlight-gold' %}selected{% endif %}>Highlight Gold</option>
              <option value="card-bg" {% if form_values.color == 'card-bg' %}selected{% endif %}>Card Background</option>
              <option value="white" {% if form_values.color == 'white' %}selected{% endif %}>White</option>
            </select>
          </div>
        </div>

        <!-- Short Description -->
        <div>
          <label for="description" class="block font-semibold mb-2">Short Description</label>
          <textarea id="description" name="description" rows="3" maxlength="100" required
                    class="w-full border border-gray-300 rounded-xl px-4 py-2 focus:ring-2 focus:ring-[#053830] focus:border-[#053830] transition-all"
                    placeholder="Enter a short summary of the service">{{ form_values.description|default:'' }}</textarea>
          <p id="descCount" class="text-sm text-gray-500 mt-1">0 / 100</p>
        </div>

        <!-- Full Description -->
        <div>
          <label for="full_description" class="block font-semibold mb-2">Full Description</label>
          <textarea id="full_description" name="full_description" rows="4" maxlength="250"
                    class="w-full border border-gray-300 rounded-xl px-4 py-2 focus:ring-2 focus:ring-[#053830] focus:border-[#053830] transition-all"
                    placeholder="Enter detailed information about this service">{{ form_values.full_description|default:'' }}</textarea>
          <p id="fullDescCount" class="text-sm text-gray-500 mt-1">0 / 250</p>
        </div>

        <div class="grid md:grid-cols-2 gap-6">
          <!-- Icon -->
          <div>
            <label for="icon" class="block font-semibold mb-2">Icon (single char)</label>
            <div class="flex items-center space-x-3">
              <input
                type="text"
                id="icon"
                name="icon"
                maxlength="4"
                placeholder="e.g. ðŸ’¡"
                value="{{ form_values.icon|default:'' }}"
                class="flex-1 border border-gray-300 rounded-xl px-4 py-2 focus:ring-2 focus:ring-[#053830] focus:border-[#053830] transition-all emoji-font"
              />
              <div
                id="iconPreview"
                class="flex items-center justify-center w-10 h-10 bg-gray-50 border border-gray-300 rounded-lg shadow-sm emoji-font text-lg"
                aria-hidden="true"
              ></div>
            </div>
            <p class="text-xs text-gray-500 mt-1">Enter a single character or emoji.</p>
          </div>

          <!-- Order -->
          <div>
            <label for="order" class="block font-semibold mb-2">Order</label>
            <input
              type="number"
              id="order"
              name="order"
              min="0"
              value="{{ form_values.order|default:0 }}"
              class="w-full border border-gray-300 rounded-xl px-4 py-2 focus:ring-2 focus:ring-[#053830] focus:border-[#053830] transition-all"
            />
          </div>
        </div>

        <!-- Image Upload with Preview (side-by-side preview button + remove) -->
        <div>
          <label for="image" class="block font-semibold mb-2">Service Image</label>

          <div class="flex items-center gap-3">
            <!-- File input (flex-grow so it matches other inputs) -->
            <input type="file" id="image" name="image" accept="image/*"
                   data-existing-url="{{ form_values.image_url|default:'' }}"
                   class="flex-grow border border-gray-300 rounded-xl px-4 py-2 bg-white focus:ring-2 focus:ring-[#053830] focus:border-[#053830] transition-all"
            />

            <!-- Preview Button styled to match inputs -->
            <button type="button" id="previewBtn"
                    class="px-4 py-2 rounded-xl border border-gray-200 bg-white text-sm font-semibold shadow-sm disabled:opacity-60 disabled:cursor-not-allowed transition"
                    disabled>
              Preview
            </button>

            <!-- âŒ REMOVE IMAGE (Option B: delete old image as well) -->
            <button type="button" id="removeImageBtn"
                    class="text-red-600 text-xl font-bold hidden hover:text-red-800 transition"
                    title="Remove selected image and clear existing saved image">
              &times;
            </button>
          </div>

          <div class="flex items-start gap-4 mt-3">
            <!-- filename / helper text -->
            <p id="file-name" class="text-sm text-gray-600 mt-1">{{ form_values.image_name|default:'' }}</p>

            <!-- thumbnail (optional) -->
            <div id="thumbWrapper" class="mt-1 hidden">
              <img id="thumbImg" src="" alt="thumbnail" class="w-40 h-24 object-cover rounded-md border border-gray-200 shadow-sm" />
            </div>
          </div>

          <!-- Hidden flag so backend knows to remove old image on submit (Option B) -->
          <input type="hidden" id="remove_image_flag" name="remove_image" value="">
        </div>

        <!-- Slug -->
        <div>
          <label for="slug" class="block font-semibold mb-2">Slug (Auto-generated)</label>
          <input type="text" id="slug" name="slug" readonly
                 value="{{ form_values.slug|default:'' }}"
                 class="w-full border border-gray-300 rounded-xl px-4 py-2 bg-gray-100 text-gray-600">
        </div>

        <!-- Submit -->
        <div class="flex justify-center mt-6">
          <button type="submit"
                  class="bg-[#053830] text-white px-8 py-3 rounded-xl font-semibold hover:bg-[#FF9728] hover:text-[#053830] transition-all shadow-lg shadow-[#053830]/40 transform hover:scale-[1.02] hover:-translate-y-1">
            Add Service
          </button>
        </div>
      </form>
    </div>



  </main>

  <!-- Centered Modal for image preview -->
  <div id="imageModal" class="fixed inset-0 hidden z-50 flex items-center justify-center">
    <!-- overlay -->
    <div id="imageModalOverlay" class="absolute inset-0 bg-black bg-opacity-60"></div>

    <!-- centered content -->
    <div class="relative z-10 max-w-4xl mx-auto w-[90%]">
      <button id="closeImageModal" class="absolute -top-4 -right-4 bg-[#053830] text-white rounded-full w-9 h-9 flex items-center justify-center text-xl shadow-lg">Ã—</button>
      <div class="bg-transparent flex justify-center items-center">
        <img id="imageModalImg" src="" alt="Full image preview" class="max-h-[80vh] w-auto rounded-md shadow-2xl" />
      </div>
    </div>
  </div>

  <!-- Data holder for JS (safe, no template tags inside external script) -->
  <div id="service-meta" data-total="{{ services|length|default:0 }}" style="display:none"></div>

  <!-- Scripts -->
 <script>
  // Safe helper: bind a counter to an input/textarea
  function bindCounter(inputId, counterId, max) {
    const input = document.getElementById(inputId);
    const counter = document.getElementById(counterId);
    if (!input || !counter) return;

    function update() {
      let val = input.value || '';
      if (val.length > max) {
        input.value = val.slice(0, max);
        val = input.value;
      }
      counter.textContent = `${val.length} / ${max}`;
      counter.classList.toggle('text-red-600', val.length > max);
    }

    input.addEventListener('input', update);
    input.addEventListener('paste', function (e) {
      e.preventDefault();
      const paste = (e.clipboardData || window.clipboardData).getData('text') || '';
      const allowed = max - (input.value ? input.value.length : 0);
      input.value = (input.value || '') + paste.slice(0, allowed);
      update();
    });

    update();
  }

  // Helper to return the first grapheme-like unit using spread (handles emojis)
  function firstGrapheme(str) {
    if (!str) return '';
    try {
      const arr = [...str];
      return arr.length ? arr[0] : '';
    } catch (e) {
      return str.charAt(0);
    }
  }

  document.addEventListener('DOMContentLoaded', function () {
    // Counters
    bindCounter('title', 'titleCount', 50);
    bindCounter('description', 'descCount', 100);
    bindCounter('full_description', 'fullDescCount', 250);

    // Slug auto-generation
    const titleInput = document.getElementById('title');
    const slugInput = document.getElementById('slug');
    if (titleInput && slugInput) {
      titleInput.addEventListener('input', function () {
        const title = this.value.toLowerCase().trim();
        slugInput.value = title.replace(/[^a-z0-9]+/g, '-').replace(/(^-|-$)/g, '');
      });
    }

    // File input preview + preview modal wiring (centered modal)
    const imageInput = document.getElementById('image');
    const fileNameEl = document.getElementById('file-name');
    const previewBtn = document.getElementById('previewBtn');
    const thumbWrapper = document.getElementById('thumbWrapper');
    const thumbImg = document.getElementById('thumbImg');
    const modal = document.getElementById('imageModal');
    const modalOverlay = document.getElementById('imageModalOverlay');
    const modalImg = document.getElementById('imageModalImg');
    const closeModalBtn = document.getElementById('closeImageModal');
    const removeBtn = document.getElementById('removeImageBtn');
    const removeFlagInput = document.getElementById('remove_image_flag');

    // Add error display element
    let imageError = document.getElementById('imageError');
    if (!imageError) {
      imageError = document.createElement('p');
      imageError.id = 'imageError';
      imageError.className = 'text-red-600 text-sm mt-1 hidden';
      imageInput.insertAdjacentElement('afterend', imageError);
    }

    let currentObjectUrl = null;

    // existing values (from server)
    const existingUrl = imageInput ? (imageInput.getAttribute('data-existing-url') || '') : '';
    const existingName = "{{ form_values.image_name|default:'' }}";
    // Helper: enable preview UI
    function enablePreview(url, filename) {
      previewBtn.disabled = false;
      if (thumbImg) {
        thumbImg.src = url;
        thumbWrapper.classList.remove('hidden');
      }
      if (fileNameEl && filename) {
        fileNameEl.textContent = filename;
      }
      if (modalImg) modalImg.src = url;
    }

    // Helper: disable preview UI
    function disablePreview() {
      previewBtn.disabled = true;
      thumbWrapper.classList.add('hidden');
      if (thumbImg) thumbImg.src = '';
      if (fileNameEl) fileNameEl.textContent = '';
      if (modalImg) modalImg.src = '';
      if (currentObjectUrl) {
        URL.revokeObjectURL(currentObjectUrl);
        currentObjectUrl = null;
      }
    }

    // Reset selection and clear remove flag (used when user selects a new file AFTER removing)
    function resetRemoveFlag() {
      if (removeFlagInput) removeFlagInput.value = '';
    }

    // FULL RESET (used by Remove button - Option B)
    function resetAllImageSelectionAndMarkRemoved() {
      // Clear the actual file input. Setting value to '' is the standard approach.
      try {
        imageInput.value = "";
      } catch (e) {
        // some browsers require wrapping in form reset; we handle the basic case
        const form = imageInput && imageInput.form;
        if (form) form.reset();
      }

      // Hide/clear preview UI
      disablePreview();

      // Mark the remove flag so backend knows to delete saved image (Option B)
      if (removeFlagInput) removeFlagInput.value = '1';

      // Show remove button only if we want to allow un-do? For Option B, keep remove button hidden after removal
      removeBtn.classList.add('hidden');

      // Update existingUrl to empty so enabling preview won't bring back old image automatically
      // (we keep the variable for JS; it doesn't change server-side automatically)
      // Note: existingUrl is const; we cannot reassign, so instead we just keep behavior to not re-enable existing preview
      // Provide user feedback
      fileNameEl.textContent = '';
    }

    // Initialize state: if there is an existing image URL, show preview and show remove button
    if (existingUrl) {
      enablePreview(existingUrl, existingName || 'Saved image');
      // If editing and an image exists, show remove button (so user can remove old image)
      removeBtn.classList.remove('hidden');
      // ensure remove flag is empty initially
      resetRemoveFlag();
    } else {
      disablePreview();
      resetRemoveFlag();
    }

    // When user selects a file
    if (imageInput && fileNameEl) {
      imageInput.addEventListener('change', function () {
        const file = this.files && this.files[0];
        imageError.classList.add('hidden');
        imageError.textContent = '';

        if (!file) {
          // No file selected (user cleared selection using native control)
          // If there was an existing saved image originally, keep showing it (unless user previously removed via remove button)
          // We'll check remove flag
          if (removeFlagInput && removeFlagInput.value === '1') {
            // user had explicitly removed image -> keep cleared state
            disablePreview();
            removeBtn.classList.add('hidden');
          } else if (existingUrl) {
            // show existing saved image again
            enablePreview(existingUrl, existingName || 'Saved image');
            removeBtn.classList.remove('hidden');
          } else {
            disablePreview();
          }
          return;
        }

        // A new file was selected -> any remove flag should be cleared (user chose new image)
        resetRemoveFlag();

        // Validation: Only allow JPG, PNG, GIF & max 10 MB
        const validTypes = ['image/jpeg', 'image/png', 'image/gif'];
        const fileExt = file.name.split('.').pop().toLowerCase();
        if (!validTypes.includes(file.type) && !['jpg', 'jpeg', 'png', 'gif'].includes(fileExt)) {
          imageError.textContent = 'âŒ Invalid file type. Only JPG, PNG, and GIF are allowed.';
          imageError.classList.remove('hidden');
          this.value = '';
          disablePreview();
          return;
        }

        if (file.size > 10 * 1024 * 1024) {
          imageError.textContent = 'âŒ File too large. Maximum allowed size is 10 MB.';
          imageError.classList.remove('hidden');
          this.value = '';
          disablePreview();
          return;
        }

        // Clean up previous object URL
        if (currentObjectUrl) {
          URL.revokeObjectURL(currentObjectUrl);
        }
        currentObjectUrl = URL.createObjectURL(file);
        enablePreview(currentObjectUrl, `Selected: ${file.name}`);

        // Show remove button (user may remove newly selected image)
        removeBtn.classList.remove('hidden');
      });
    }

    // Preview modal open
    previewBtn.addEventListener('click', function () {
      if (!modalImg.src) return;
      modal.classList.remove('hidden');
      closeModalBtn.focus();
    });

    function closeModal() {
      modal.classList.add('hidden');
    }
    closeModalBtn.addEventListener('click', closeModal);
    modalOverlay.addEventListener('click', closeModal);
    document.addEventListener('keydown', function (e) {
      if (e.key === 'Escape' && !modal.classList.contains('hidden')) {
        closeModal();
      }
    });

    // Remove image button behavior (Option B) - remove both selected and existing saved image
    removeBtn.addEventListener('click', function () {
      // Mark for removal and clear UI
      resetAllImageSelectionAndMarkRemoved();
    });

    // Icon input handling (single emoji or char)
    const iconInput = document.getElementById('icon');
    const iconPreview = document.getElementById('iconPreview');
    if (iconInput) {
      const initial = (iconInput.value || '').trim();
      if (initial) {
        iconInput.value = firstGrapheme(initial);
        if (iconPreview) iconPreview.textContent = iconInput.value;
      } else if (iconPreview) {
        iconPreview.textContent = '';
      }

      iconInput.addEventListener('input', function () {
        const val = this.value || '';
        const g = firstGrapheme(val);
        this.value = g;
        if (iconPreview) iconPreview.textContent = g;
      });

      iconInput.addEventListener('paste', function (e) {
        e.preventDefault();
        const paste = (e.clipboardData || window.clipboardData).getData('text') || '';
        this.value = firstGrapheme(paste);
        if (iconPreview) iconPreview.textContent = this.value;
      });
    }

    // Toggle hidden service rows
    const toggleBtn = document.getElementById('toggle-services-btn');
    const hiddenRows = document.querySelectorAll('.hidden-service');
    let isExpanded = false;
    const meta = document.getElementById('service-meta');
    const totalServices = meta ? (parseInt(meta.dataset.total, 10) || 0) : 0;
    const hiddenCountInitial = Math.max(totalServices - 5, 0);

    if (toggleBtn) {
      toggleBtn.textContent = `Show All ${totalServices} Services (${hiddenCountInitial} hidden)`;
      toggleBtn.addEventListener('click', function () {
        isExpanded = !isExpanded;
        hiddenRows.forEach(row => row.classList.toggle('hidden'));
        if (isExpanded) {
          this.textContent = 'Show Less (Collapse View)';
          window.scrollTo({ top: this.offsetTop - 120, behavior: 'smooth' });
        } else {
          const hiddenCount = Math.max(totalServices - 5, 0);
          this.textContent = `Show All ${totalServices} Services (${hiddenCount} hidden)`;
        }
      });
    }
  });
</script>

<script>
  // Show loader on page load
  window.addEventListener("load", () => {
      const loader = document.getElementById("blur-loader");
      if (loader) loader.classList.add("hidden");  // hide after page fully loads
  });

  // Show loader on page visit instantly
  document.addEventListener("DOMContentLoaded", () => {
      const loader = document.getElementById("blur-loader");
      if (loader) loader.classList.remove("hidden");
  });

  // Show loader when submitting Add Service Form
  const serviceForm = document.getElementById("add-service-form");
  if (serviceForm) {
      serviceForm.addEventListener("submit", () => {
          const bl = document.getElementById("blur-loader");
          if (bl) bl.classList.remove("hidden");
      });
  }
</script>

</body>
</html>