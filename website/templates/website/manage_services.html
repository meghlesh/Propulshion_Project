{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Manage Services | Propulsion Technology</title>
  <link rel="icon" type="image/png" href="{% static 'img/logo6.png'%}">
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    /* ensure emoji-capable fonts are available for preview & inputs */
    .emoji-font {
      font-family: "Segoe UI Emoji", "Apple Color Emoji", "Noto Color Emoji", "Segoe UI Symbol", system-ui, sans-serif;
      font-size: 1.4rem;
      line-height: 1;
      vertical-align: middle;
    }
    #image-preview {
        transition: opacity 0.3s ease;
    }
  </style>
</head>
<body class="bg-[#EAF4E0] font-sans text-[#053830]">

<!-- Blur Loader -->
<div id="blur-loader"
     class="fixed inset-0 flex items-center justify-center bg-white/60 backdrop-blur-md z-[9999] hidden">
    <div class="w-16 h-16 border-4 border-[#053830] border-t-transparent rounded-full animate-spin"></div>
</div>

  <!-- Navbar -->
  <nav class="bg-[#053830] text-white p-5 flex justify-between items-center shadow-lg">
    <h1 class="text-2xl font-bold">Manage Services</h1>
    <div>
      <a href="{% url 'home' %}" class="text-[#FF9728] font-semibold hover:text-[#FFB857] mr-6 transition">Back To Home</a>
      <a href="{% url 'admin_dashboard' %}" class="text-[#FF9728] font-semibold hover:text-[#FFB857] mr-6">Dashboard</a>
      <a href="{% url 'admin_logout' %}" class="bg-[#FF9728] text-[#053830] px-5 py-1.5 rounded-xl font-semibold hover:bg-[#FFB857] transition">Logout</a>
    </div>
  </nav>

  <main class="max-w-6xl mx-auto mt-10 p-6 bg-white rounded-3xl shadow-2xl">
    <h2 class="text-3xl font-extrabold mb-6 text-center text-[#053830]">Service Inventory</h2>

{% if messages %}
    <div id="flash-message-wrapper">
        {% for message in messages %}
            {% if "deleted" in message.message|lower %}
                <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-xl shadow-md mb-6" role="alert">
                    {{ message }}
                </div>
            {% else %}
                <div class="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded-xl shadow-md mb-6" role="alert">
                    ‚úÖ {{ message }}
                </div>
            {% endif %}
        {% endfor %}
    </div>
{% endif %}

    <!-- Service Table Container -->
    <div class="mb-6">
      <div class="overflow-x-auto">
        <table class="min-w-full border border-gray-200 rounded-xl overflow-hidden shadow-lg">
          <thead class="bg-[#053830] text-white">
            <tr>
              <th class="px-6 py-3 text-left">Title</th>
              <th class="px-6 py-3 text-left">Description</th>
              <th class="px-6 py-3 text-left">Color</th>
              <th class="px-6 py-3 text-left">Order</th>
              <th class="px-6 py-3 text-center">Actions</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-gray-200" id="service-list">
            {% for service in services %}
              <tr class="hover:bg-[#F7FBF5] transition-all {% if forloop.counter > 5 %}hidden-service hidden{% endif %}">
                <td class="px-6 py-3 font-semibold">{{ service.title }}</td>
                <td class="px-6 py-3">{{ service.description|truncatechars:60 }}</td>
                <td class="px-6 py-3">{{ service.color }}</td>
                <td class="px-6 py-3">{{ service.order }}</td>
                <td class="px-6 py-3 text-center">
                  <div class="flex items-center justify-center space-x-2 whitespace-nowrap">
                    <a href="{% url 'edit_service' service.id %}" class="text-blue-600 hover:text-blue-800 font-semibold transition-colors">Edit</a>
                    <span class="text-gray-300">|</span>
                    <a href="{% url 'delete_service' service.id %}" class="text-red-600 hover:text-red-800 font-semibold transition-colors">Delete</a>
                  </div>
                </td>
              </tr>
            {% empty %}
              <tr>
                <td colspan="5" class="text-center py-6 text-gray-500">No services found yet.</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      {% if services|length > 5 %}
        <div id="toggle-container" class="text-center mt-6">
          <button id="toggle-services-btn" type="button"
              class="text-white bg-[#053830] px-6 py-2 rounded-xl font-semibold hover:bg-[#FF9728] hover:text-[#053830] transition-all shadow-lg transform hover:scale-[1.02]">
            Show All {{ services|length }} Services ({{ services|length|add:"-5" }} hidden)
          </button>
        </div>
      {% endif %}
    </div>

    <!-- Add New Service Form -->
    <div class="bg-[#EAF4E0] p-8 rounded-2xl shadow-inner mt-8">
      <h3 class="text-2xl font-bold mb-6 text-[#053830]">Add New Service</h3>

      <form method="POST" enctype="multipart/form-data" class="space-y-6" id="add-service-form">
        {% csrf_token %}

        <div class="grid md:grid-cols-2 gap-6">
          <!-- Title -->
          <div>
            <label for="title" class="block font-semibold mb-2">Title <span class="text-red-600">*</span> </label>
            <input type="text" id="title" name="title" maxlength="40" required
                   value="{{ form_values.title|default:'' }}"
                   class="w-full border border-gray-300 rounded-xl px-4 py-2 focus:ring-2 focus:ring-[#053830] focus:border-[#053830] transition-all">
            <p id="titleCount" class="text-sm text-gray-500 mt-1">0 / 40</p>
          </div>

          <!-- Color -->
          <div>
            <label for="color" class="block font-semibold mb-2">Color</label>
            <select id="color" name="color" required
                    class="w-full border border-gray-300 rounded-xl px-4 py-2 focus:ring-2 focus:ring-[#053830] focus:border-[#053830] transition-all">
              <option value="accent-green" {% if form_values.color == 'accent-green' %}selected{% endif %}>Accent Green</option>
              <option value="highlight-gold" {% if form_values.color == 'highlight-gold' %}selected{% endif %}>Highlight Gold</option>
              <option value="card-bg" {% if form_values.color == 'card-bg' %}selected{% endif %}>Card Background</option>
              <option value="white" {% if form_values.color == 'white' %}selected{% endif %}>White</option>
            </select>
          </div>
        </div>

        <!-- Short Description -->
        <div>
          <label for="description" class="block font-semibold mb-2">Short Description <span class="text-red-600">*</span> </label>
          <textarea id="description" name="description" rows="3" maxlength="100" required
                    class="w-full border border-gray-300 rounded-xl px-4 py-2 focus:ring-2 focus:ring-[#053830] focus:border-[#053830] transition-all"
                    placeholder="Enter a short summary of the service">{{ form_values.description|default:'' }}</textarea>
          <p id="descCount" class="text-sm text-gray-500 mt-1">0 / 100</p>
        </div>

        <!-- Full Description -->
        <div>
          <label for="full_description" class="block font-semibold mb-2">Full Description <span class="text-red-600">*</span> </label>
          <textarea id="full_description" name="full_description" rows="4" maxlength="250"
                    class="w-full border border-gray-300 rounded-xl px-4 py-2 focus:ring-2 focus:ring-[#053830] focus:border-[#053830] transition-all"
                    placeholder="Enter detailed information about this service">{{ form_values.full_description|default:'' }}</textarea>
          <p id="fullDescCount" class="text-sm text-gray-500 mt-1">0 / 250</p>
        </div>

        <div class="grid md:grid-cols-2 gap-6">
          <!-- Icon -->
          <div>
            <label for="icon" class="block font-semibold mb-2">Icon (single char) <span class="text-red-600">*</span></label>
            <div class="flex items-center space-x-3">
              <input
                type="text"
                id="icon"
                name="icon"
                maxlength="4"
                placeholder="e.g. üí°"
                value="{{ form_values.icon|default:'' }}"
                required
                class="flex-1 border border-gray-300 rounded-xl px-4 py-2 focus:ring-2 focus:ring-[#053830] focus:border-[#053830] transition-all emoji-font"
              />
              <div
                id="iconPreview"
                class="flex items-center justify-center w-10 h-10 bg-gray-50 border border-gray-300 rounded-lg shadow-sm emoji-font text-lg"
                aria-hidden="true"
              ></div>
            </div>
            <p class="text-xs text-gray-500 mt-1">Enter a single character or emoji.</p>
          </div>

          <!-- Order -->
          <div>
            <label for="order" class="block font-semibold mb-2">Order <span class="text-red-600">*</span> </label>
            <input
              type="number"
              id="order"
              name="order"
              min="0"
              value="{{ form_values.order|default:0 }}"
              class="w-full border border-gray-300 rounded-xl px-4 py-2 focus:ring-2 focus:ring-[#053830] focus:border-[#053830] transition-all"
            />
          </div>
        </div>

        <!-- NEW IMAGE SECTION (MATCHING PORTFOLIO) -->
        <div>
          <label for="image" class="block font-semibold mb-2">Service Image <span class="text-red-600">*</span></label>
          
          <!-- Image Input -->
          <input 
            id="image" 
            type="file" 
            name="image" 
            accept=".jpg,.jpeg,.png,.gif,.webp" 
            class="w-full border border-gray-300 rounded-xl px-4 py-2 bg-white focus:ring-2 focus:ring-[#053830] focus:border-[#053830] transition-all"
            data-existing-url="{{ form_values.image_url|default:'' }}"
          >
          
          <p id="service-file-name" class="text-sm text-gray-600 mt-1">{{ form_values.image_name|default:'' }}</p>
          <p id="image-error" class="text-red-600 text-sm hidden mt-1"></p>
          <p class="text-gray-500 text-xs mt-1">Allowed formats: JPG, JPEG, PNG, WEBP (Max 5 MB)</p>

          <!-- Preview Container: Hidden by default -->
          <div id="image-preview-container" class="mt-4 hidden">
            <img id="image-preview" src="" class="h-36 rounded-xl shadow border object-cover">
            <button id="remove-image-btn" type="button" class="bg-red-600 text-white text-xs px-2 py-1 rounded-md mt-2">Remove</button>
          </div>

          <!-- Hidden flag to signal removal to backend if needed -->
          <input type="hidden" id="remove_image_flag" name="remove_image" value="">
        </div>

        <!-- Slug -->
        <div>
          <label for="slug" class="block font-semibold mb-2">Slug (Auto-generated) <span class="text-red-600">*</span> </label>
          <input type="text" id="slug" name="slug" readonly
                 value="{{ form_values.slug|default:'' }}"
                 class="w-full border border-gray-300 rounded-xl px-4 py-2 bg-gray-100 text-gray-600">
        </div>

        <!-- Submit -->
        <div class="flex justify-center mt-6">
          <button type="submit"
                  class="bg-[#053830] text-white px-8 py-3 rounded-xl font-semibold hover:bg-[#FF9728] hover:text-[#053830] transition-all shadow-lg shadow-[#053830]/40 transform hover:scale-[1.02] hover:-translate-y-1">
            Add Service
          </button>
        </div>
      </form>
    </div>

  </main>

  <!-- Data holder for JS -->
  <div id="service-meta" data-total="{{ services|length|default:0 }}" style="display:none"></div>

  <!-- Scripts -->
 <script>
  // Safe helper: bind a counter to an input/textarea
  function bindCounter(inputId, counterId, max) {
    const input = document.getElementById(inputId);
    const counter = document.getElementById(counterId);
    if (!input || !counter) return;

    function update() {
      let val = input.value || '';
      if (val.length > max) {
        input.value = val.slice(0, max);
        val = input.value;
      }
      counter.textContent = `${val.length} / ${max}`;
      counter.classList.toggle('text-red-600', val.length > max);
    }

    input.addEventListener('input', update);
    input.addEventListener('paste', function (e) {
      e.preventDefault();
      const paste = (e.clipboardData || window.clipboardData).getData('text') || '';
      const allowed = max - (input.value ? input.value.length : 0);
      input.value = (input.value || '') + paste.slice(0, allowed);
      update();
    });

    update();
  }

  // Helper to return the first grapheme-like unit using spread (handles emojis)
  function firstGrapheme(str) {
    if (!str) return '';
    try {
      const arr = [...str];
      return arr.length ? arr[0] : '';
    } catch (e) {
      return str.charAt(0);
    }
  }

  document.addEventListener('DOMContentLoaded', function () {
    // Counters
    bindCounter('title', 'titleCount', 40);
    bindCounter('description', 'descCount', 100);
    bindCounter('full_description', 'fullDescCount', 250);

    // Slug auto-generation
    const titleInput = document.getElementById('title');
    const slugInput = document.getElementById('slug');
    if (titleInput && slugInput) {
      titleInput.addEventListener('input', function () {
        const title = this.value.toLowerCase().trim();
        slugInput.value = title.replace(/[^a-z0-9]+/g, '-').replace(/(^-|-$)/g, '');
      });
    }

    /* --- NEW IMAGE HANDLING LOGIC (From Portfolio) --- */
    const imageInput = document.getElementById("image");
    const fileNameEl = document.getElementById("service-file-name");
    const errorEl = document.getElementById("image-error");
    const previewContainer = document.getElementById("image-preview-container");
    const previewImage = document.getElementById("image-preview");
    const removeBtn = document.getElementById("remove-image-btn");
    const removeFlagInput = document.getElementById('remove_image_flag');

    // 1. Check for existing image (from server rendering)
    let existingUrl = imageInput ? (imageInput.getAttribute('data-existing-url') || '') : '';
    
    // Safety check for Preview Environment:
    // If 'existingUrl' contains raw Django template braces "{{", treat it as empty.
    if (existingUrl.includes('{{')) {
        existingUrl = "";
    }

    // Initialize: if we have a valid existing URL and NO new file selected yet, show it
    if (existingUrl && (!imageInput.files || imageInput.files.length === 0)) {
        previewImage.src = existingUrl;
        previewContainer.classList.remove("hidden");
        if(removeFlagInput) removeFlagInput.value = "";
    } else {
        // Ensure strictly hidden if no URL
        if(previewContainer) previewContainer.classList.add("hidden");
    }

    let imageValid = true;

    if (imageInput) {
        imageInput.addEventListener("change", function () {
            const file = this.files[0];
            const validTypes = ["image/jpeg", "image/png", "image/gif", "image/webp"];
            const maxSizeMB = 5;

            // Reset UI
            imageValid = true;
            errorEl.classList.add("hidden");
            previewContainer.classList.add("hidden");
            previewImage.src = "";
            fileNameEl.textContent = "";
            
            // If user cancels selection
            if (!file) {
                // If we had an existing image and user cancelled, we revert to existing image? 
                if (existingUrl) {
                    previewImage.src = existingUrl;
                    previewContainer.classList.remove("hidden");
                    if(removeFlagInput) removeFlagInput.value = "";
                }
                return;
            }

            // Validate Type
            if (!validTypes.includes(file.type)) {
                errorEl.textContent = "‚ùå Invalid file type. Upload JPG, PNG, GIF or WEBP.";
                errorEl.classList.remove("hidden");
                imageValid = false;
                this.value = ""; // clear input
                return;
            }

            // Validate Size
            const sizeMB = file.size / (1024 * 1024);
            if (sizeMB > maxSizeMB) {
                errorEl.textContent = `‚ùå File too large (${sizeMB.toFixed(2)}MB). Max 5MB allowed.`;
                errorEl.classList.remove("hidden");
                imageValid = false;
                this.value = ""; // clear input
                return;
            }

            // Show Preview
            fileNameEl.textContent = `Selected: ${file.name}`;
            const reader = new FileReader();
            reader.onload = e => {
                previewImage.src = e.target.result;
                previewContainer.classList.remove("hidden");
                // Reset remove flag because we are uploading a new one
                if(removeFlagInput) removeFlagInput.value = "";
            };
            reader.readAsDataURL(file);
        });
    }

    if (removeBtn) {
        removeBtn.addEventListener("click", () => {
            // Clear input
            imageInput.value = "";
            // Hide preview
            previewImage.src = "";
            previewContainer.classList.add("hidden");
            fileNameEl.textContent = "";
            errorEl.classList.add("hidden");
            imageValid = true;

            // Set remove flag so backend knows to delete the image
            if(removeFlagInput) removeFlagInput.value = "1";
        });
    }

    // Expose imageValid to global scope or attach to form for submit validation
    window.isServiceImageValid = () => imageValid;

    /* --- END IMAGE LOGIC --- */


    // Icon input handling (single emoji or char)
    const iconInput = document.getElementById('icon');
    const iconPreview = document.getElementById('iconPreview');
    if (iconInput) {
      const initial = (iconInput.value || '').trim();
      if (initial) {
        iconInput.value = firstGrapheme(initial);
        if (iconPreview) iconPreview.textContent = iconInput.value;
      } else if (iconPreview) {
        iconPreview.textContent = '';
      }

      iconInput.addEventListener('input', function () {
        const val = this.value || '';
        const g = firstGrapheme(val);
        this.value = g;
        if (iconPreview) iconPreview.textContent = g;
      });

      iconInput.addEventListener('paste', function (e) {
        e.preventDefault();
        const paste = (e.clipboardData || window.clipboardData).getData('text') || '';
        this.value = firstGrapheme(paste);
        if (iconPreview) iconPreview.textContent = this.value;
      });
    }

    // Toggle hidden service rows
    const toggleBtn = document.getElementById('toggle-services-btn');
    const hiddenRows = document.querySelectorAll('.hidden-service');
    let isExpanded = false;
    const meta = document.getElementById('service-meta');
    const totalServices = meta ? (parseInt(meta.dataset.total, 10) || 0) : 0;
    const hiddenCountInitial = Math.max(totalServices - 5, 0);

    if (toggleBtn) {
      toggleBtn.textContent = `Show All ${totalServices} Services (${hiddenCountInitial} hidden)`;
      toggleBtn.addEventListener('click', function () {
        isExpanded = !isExpanded;
        hiddenRows.forEach(row => row.classList.toggle('hidden'));
        if (isExpanded) {
          this.textContent = 'Show Less (Collapse View)';
          window.scrollTo({ top: this.offsetTop - 120, behavior: 'smooth' });
        } else {
          const hiddenCount = Math.max(totalServices - 5, 0);
          this.textContent = `Show All ${totalServices} Services (${hiddenCount} hidden)`;
        }
      });
    }
  });
</script>

<script>
  // Show loader on page load
  window.addEventListener("load", () => {
      const loader = document.getElementById("blur-loader");
      if (loader) loader.classList.add("hidden");  // hide after page fully loads
  });

  // Show loader on page visit instantly
  document.addEventListener("DOMContentLoaded", () => {
      const loader = document.getElementById("blur-loader");
      if (loader) loader.classList.remove("hidden");
  });

  // Show loader when submitting Add Service Form
  const serviceForm = document.getElementById("add-service-form");

if (serviceForm) {
  serviceForm.addEventListener("submit", function (e) {
    let isValid = true; // assume valid

    // Reset previous image errors (generic alert handled here, specific field errors handled by listener)
    const imageError = document.getElementById("image-error");

    // Get all required inputs
    const title = document.getElementById("title").value.trim();
    const description = document.getElementById("description").value.trim();
    const fullDesc = document.getElementById("full_description").value.trim();
    const order = document.getElementById("order").value;
    const imageInput = document.getElementById("image");
    const iconInput = document.getElementById("icon");
    
    // Validate text fields
    if (!title || !description || !fullDesc || !order) {
      alert("‚ùå Please fill in all required fields.");
      isValid = false;
    }

    // Ensure icon is provided (this field is now compulsory)
    const iconVal = iconInput ? (iconInput.value || '').trim() : '';
    if (!iconVal) {
      alert("‚ùå Please enter an icon (single character or emoji).");
      if (iconInput) iconInput.focus();
      isValid = false;
    }

    // Check strict image validity from our custom validator
    if (window.isServiceImageValid && !window.isServiceImageValid()) {
        isValid = false;
    }

    // Prevent submission if invalid
    if (!isValid) {
      e.preventDefault();
      return false;
    }

    // Show loader if valid
    const loader = document.getElementById("blur-loader");
    if (loader) loader.classList.remove("hidden");
  });
}

</script>

<script>
    setTimeout(() => {
        const box = document.getElementById("flash-message-wrapper");
        if (box) box.style.display = "none";
    }, 2000);
</script>


</body>
</html>
