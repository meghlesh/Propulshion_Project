{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Edit Portfolio | Propulsion Technology</title>
  <link rel="icon" type="image/png" href="{% static 'img/logo6.png' %}">
  <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-[#EAF4E0] font-sans text-[#053830]">

<!-- Blur Loader -->
<div id="blur-loader" class="fixed inset-0 flex items-center justify-center bg-white/60 backdrop-blur-md z-[9999] hidden">
  <div class="w-16 h-16 border-4 border-[#053830] border-t-transparent rounded-full animate-spin"></div>
</div>

<nav class="bg-[#053830] text-white p-5 flex justify-between items-center shadow-xl">
  <h1 class="text-3xl font-extrabold tracking-wider">Edit Portfolio</h1>
  <div>
    <a href="{% url 'manage_portfolio' %}" class="text-[#FF9728] font-semibold hover:text-white mr-6">Back to Portfolio</a>
    <a href="{% url 'admin_logout' %}" class="bg-[#FF9728] text-[#053830] px-4 py-2 rounded-xl font-semibold hover:bg-white hover:text-[#053830] transition-all shadow-md">Logout</a>
  </div>
</nav>

<main class="max-w-3xl mx-auto mt-16 p-8 bg-white rounded-3xl shadow-2xl">
  <h2 class="text-3xl font-extrabold mb-8 text-center">Update Portfolio Item</h2>

  {% if messages %}
  <div id="flash-message-wrapper">
    {% for message in messages %}
      <div class="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded-xl mb-6 shadow-md">
        ✓ {{ message }}
      </div>
    {% endfor %}
  </div>
  {% endif %}

<form method="POST" enctype="multipart/form-data" class="space-y-6">
  {% csrf_token %}

  <!-- Title -->
  <div>
    <label class="font-semibold">Title <span class="text-red-600">*</span></label>
    <input id="title" name="title" type="text" value="{{ portfolio.title }}" required 
      class="w-full border border-gray-300 rounded-xl px-4 py-2">
    <p id="title-counter" class="text-sm mt-1"></p>
  </div>

  <!-- Category -->
  <div>
    <label class="font-semibold">Category <span class="text-red-600">*</span></label>
    <input id="category" name="category" type="text" value="{{ portfolio.category }}" 
      class="w-full border border-gray-300 rounded-xl px-4 py-2">
    <p id="category-counter" class="text-sm mt-1"></p>
  </div>

  <!-- Description -->
  <div>
    <label class="font-semibold">Description <span class="text-red-600">*</span></label>
    <textarea id="description" name="description" rows="4"
      class="w-full border border-gray-300 rounded-xl px-4 py-2">{{ portfolio.description }}</textarea>
    <p id="description-counter" class="text-sm mt-1"></p>
  </div>

  <!-- Order -->
  <div>
    <label class="font-semibold">Order <span class="text-red-600">*</span></label>
    <input id="order" name="order" type="number" value="{{ portfolio.order }}"
      class="w-full border border-gray-300 rounded-xl px-4 py-2">
  </div>

<!-- Image -->
<div>
  <label class="font-semibold">Project Image <span class="text-red-600">*</span></label>

  {% if portfolio.image %}
    <img src="{{ portfolio.image.url }}" class="w-48 h-32 object-cover rounded-xl mb-4 border shadow-md">
    <input type="hidden" name="old_image" value="1">
  {% endif %}

  <input id="image" type="file" name="image" accept=".jpg,.jpeg,.png,.gif"
    class="w-full border border-gray-300 rounded-xl px-4 py-2 bg-white">
  <p id="file-name" class="text-sm"></p>
  <p id="image-error" class="text-red-600 text-sm hidden"></p>

  <div id="preview-wrapper" class="hidden mt-4">
    <img id="preview" class="h-36 rounded-xl border shadow object-cover">
    <button type="button" id="remove-image-btn"
      class="bg-red-600 text-white text-xs px-2 py-1 rounded-md mt-2">Remove</button>
  </div>
</div>

  <!-- Slug -->
  <div>
    <label class="font-semibold">Slug (Auto) <span class="text-red-600">*</span></label>
    <input id="slug" name="slug" type="text" value="{{ portfolio.slug }}" readonly
      class="w-full border border-gray-300 rounded-xl px-4 py-2 bg-gray-100 text-gray-600">
  </div>

  <div class="flex justify-center pt-4">
    <button type="submit"
      class="bg-[#053830] text-white px-8 py-3 rounded-xl hover:bg-[#FF9728] hover:text-[#053830] transition-all shadow-lg">
      Save Changes
    </button>
  </div>
</form>
</main>

<script>
/* Character counter + block typing */
function bindCounter(id, counterId, max) {
  const inp = document.getElementById(id);
  const counter = document.getElementById(counterId);

  if (!inp) return;
  function update(e) {
    let v = inp.value;
    if (v.length >= max && e?.inputType === "insertText") e.preventDefault();
    if (v.length > max) inp.value = v.slice(0, max);
    counter.textContent = `${inp.value.length} / ${max}`;
    counter.classList.toggle("text-red-600", inp.value.length >= max);
  }
  inp.addEventListener("beforeinput", update);
  inp.addEventListener("input", update);
  update();
}
bindCounter("title", "title-counter", 50);
bindCounter("category", "category-counter", 50);
bindCounter("description", "description-counter", 250);
</script>

<script>
/* Auto-slug */
document.getElementById("title").addEventListener("input", function () {
  document.getElementById("slug").value = this.value
    .toLowerCase()
    .replace(/[^a-z0-9\s-]/g, "")
    .trim()
    .replace(/\s+/g, "-");
});
</script>

<script>
/* Image validation – 5MB + preview */
const input = document.getElementById("image");
const fileName = document.getElementById("file-name");
const err = document.getElementById("image-error");
const previewWrap = document.getElementById("preview-wrapper");
const preview = document.getElementById("preview");
const removeBtn = document.getElementById("remove-image-btn");

input.addEventListener("change", function () {
  const file = this.files[0];
  const maxMB = 5;
  const valid = ["image/jpeg", "image/png", "image/gif"];

  err.classList.add("hidden");
  previewWrap.classList.add("hidden");
  preview.src = "";
  fileName.textContent = "";

  if (!file) return;

  if (!valid.includes(file.type)) {
    err.textContent = "❌ Invalid file type (only JPG/PNG/GIF allowed)";
    err.classList.remove("hidden");
    this.value = "";
    return;
  }

  const sizeMB = file.size / (1024 * 1024);
  if (sizeMB > maxMB) {
    err.textContent = `❌ File too large (${sizeMB.toFixed(2)}MB). Max 5MB allowed`;
    err.classList.remove("hidden");
    this.value = "";
    return;
  }

  fileName.textContent = `Selected: ${file.name}`;
  const reader = new FileReader();
  reader.onload = e => {
    preview.src = e.target.result;
    previewWrap.classList.remove("hidden");
  };
  reader.readAsDataURL(file);
});

removeBtn.addEventListener("click", () => {
  input.value = "";
  preview.src = "";
  previewWrap.classList.add("hidden");
  fileName.textContent = "";
  err.classList.add("hidden");
});
</script>

<script>
/* Loader */
document.addEventListener("DOMContentLoaded", () => {
  document.getElementById("blur-loader").classList.remove("hidden");
});
window.addEventListener("load", () => {
  document.getElementById("blur-loader").classList.add("hidden");
});
document.querySelector("form").addEventListener("submit", () => {
  document.getElementById("blur-loader").classList.remove("hidden");
});
</script>

<script>
/* Auto-hide flash messages */
setTimeout(() => {
  const msg = document.getElementById("flash-message-wrapper");
  if (msg) msg.style.display = "none";
}, 2000);
</script>

</body>
</html>