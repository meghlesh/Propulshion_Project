{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Manage Jobs | Propulsion Technology</title>
  <link rel="icon" type="image/png" href="{% static 'img/logo6.png'%}">
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-[#EAF4E0] font-sans text-[#053830]">

<!-- Blur Loader -->
<div id="blur-loader"
     class="fixed inset-0 flex items-center justify-center bg-white/60 backdrop-blur-md z-[9999] hidden">
  <div class="w-16 h-16 border-4 border-[#053830] border-t-transparent rounded-full animate-spin"></div>
</div>

  <!-- Navbar -->
  <nav class="bg-[#053830] text-white p-5 flex justify-between items-center shadow-lg">
    <h1 class="text-2xl font-bold">Manage Jobs</h1>
    <div class="flex items-center">
      <a href="{% url 'home' %}" class="text-[#FF9728] font-semibold hover:text-white mr-6 transition-colors">Back To Home</a>
      <a href="{% url 'admin_dashboard' %}" class="text-[#FF9728] font-semibold hover:text-white mr-6">Dashboard</a>
      <a href="{% url 'admin_logout' %}" class="bg-[#FF9728] text-[#053830] px-5 py-1.5 rounded-xl font-semibold hover:bg-[#FFB857] transition">Logout</a>
    </div>
  </nav>

  <main class="max-w-6xl mx-auto mt-10 p-6 bg-white rounded-3xl shadow-2xl">
    <h2 class="text-3xl font-extrabold mb-6 text-center">All Job Postings</h2>

    {% if messages %}
    <div id="flash-msg-box">
        {% for message in messages %}
            {% if "deleted" in message.message|lower %}
                <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-xl shadow-md mb-6" role="alert">
                    {{ message }}
                </div>
            {% else %}
                <div class="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded-xl shadow-md mb-6" role="alert">
                    ✅ {{ message }}
                </div>
            {% endif %}
        {% endfor %}
    </div>
{% endif %}

    <!-- Job Table -->
    <div class="overflow-x-auto mb-12">
      <table class="min-w-full border border-gray-200 rounded-xl overflow-hidden shadow-sm">
        <thead class="bg-[#053830] text-white">
          <tr>
            <th class="px-6 py-3 text-left">Title</th>
            <th class="px-6 py-3 text-left">Location</th>
            <th class="px-6 py-3 text-left">Posted On</th>
            <th class="px-6 py-3 text-left">Status</th>
            <th class="px-6 py-3 text-center">Actions</th>
          </tr>
        </thead>
        <tbody class="divide-y divide-gray-200">
          {% for job in jobs %}
          <tr id="job-row-{{ job.id }}" class="hover:bg-[#EAF4E0] transition-all">
            <td class="px-6 py-3 font-semibold">{{ job.title }}</td>
            <td class="px-6 py-3">{{ job.location }}</td>
            <td class="px-6 py-3">{{ job.posted_at|date:"M d, Y" }}</td>
            <td class="px-6 py-3">
              {% if job.is_active %}
                <span class="text-green-700 font-semibold">Active</span>
              {% else %}
                <span class="text-red-600 font-semibold">Closed</span>
              {% endif %}
            </td>
            <td class="px-6 py-3 text-center">
              <div class="flex items-center justify-center space-x-2 whitespace-nowrap">
                <a href="{% url 'edit_job' job.id %}" class="text-blue-600 hover:text-blue-800 font-semibold transition-colors">Edit</a>
                <span class="text-gray-400">|</span>
                <form action="{% url 'delete_job' job.id %}" method="POST"
      onsubmit="return confirm('Are you sure you want to delete this job?')">
    {% csrf_token %}
    <button type="submit" class="text-red-600 hover:text-red-800 font-semibold">
        Delete
    </button>
</form>


              </div>
            </td>
          </tr>
          {% empty %}
          <tr>
            <td colspan="5" class="text-center py-6 text-gray-500">No job postings yet.</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <!-- Add New Job Form -->
    <div class="bg-[#EAF4E0] p-8 rounded-2xl shadow-inner">
      <h3 class="text-2xl font-bold mb-6 text-[#053830]">Add New Job</h3>
        <form method="POST" class="space-y-6" id="jobForm">
  {% csrf_token %}
  <div class="grid md:grid-cols-2 gap-6">

    <!-- Job Title -->
    <div>
      <label for="title" class="block font-semibold mb-2">
        Job Title <span class="text-red-600">*</span> (max 100 characters)
      </label>
      <input type="text" id="title" name="title" maxlength="100" required
             class="limit-field w-full border border-gray-300 rounded-xl px-4 py-2"
             data-limit="100">
      <p class="text-sm text-gray-600 mt-1"><span id="title-count">0</span> / 100</p>
    </div>

    <!-- Location -->
    <div>
      <label for="location" class="block font-semibold mb-2">
        Location <span class="text-red-600">*</span> (max 50 characters)
      </label>
      <input type="text" id="location" name="location" maxlength="50" required
             class="limit-field w-full border border-gray-300 rounded-xl px-4 py-2"
             data-limit="50">
      <p class="text-sm text-gray-600 mt-1"><span id="location-count">0</span> / 50</p>
    </div>
  </div>

  <!-- Job Description -->
  <div>
    <label for="description" class="block font-semibold mb-2">
      Job Description <span class="text-red-600">*</span> (max 250 characters)
    </label>
    <textarea id="description" name="description" rows="3" maxlength="250" required
              class="limit-field w-full border border-gray-300 rounded-xl px-4 py-2"
              data-limit="250"></textarea>
    <p class="text-sm text-gray-600 mt-1"><span id="description-count">0</span> / 250</p>
  </div>

  <!-- Requirements -->
  <div>
    <label for="requirements" class="block font-semibold mb-2">
      Requirements (max 100 characters)<span class="text-red-600">*</span>
    </label>
    <textarea id="requirements" name="requirements" rows="3" maxlength="100"
              class="limit-field w-full border border-gray-300 rounded-xl px-4 py-2"
              data-limit="100"></textarea>
    <p class="text-sm text-gray-600 mt-1"><span id="requirements-count">0</span> / 100</p>
  </div>

  <div class="flex items-center">
    <input type="checkbox" id="is_active" name="is_active" class="mr-2" checked>
    <label for="is_active" class="font-semibold">Active Job Posting</label>
  </div>

  <div class="flex justify-center mt-6">
    <button type="submit"
            class="bg-[#053830] text-white px-8 py-3 rounded-xl font-semibold hover:bg-[#FF9728] hover:text-[#053830] transition-all shadow-lg shadow-[#053830]/40 transform hover:scale-[1.02] hover:-translate-y-1">
      Add Job
    </button>
  </div>
</form>

      
    </div>
  </main>

  <!-- Delete Confirmation Overlay -->
  <div id="overlay" class="hidden fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50">
    <div class="bg-white rounded-2xl p-6 w-[90%] max-w-sm text-center shadow-2xl">
      <h2 class="text-xl font-bold text-[#053830] mb-4">Delete Job</h2>
      <p class="text-gray-700 mb-6">Are you sure you want to delete this job?</p>
      <div class="flex justify-center space-x-4">
        <button id="confirmDeleteBtn" class="bg-red-600 text-white px-4 py-2 rounded-xl hover:bg-red-700 transition-all">Delete</button>
        <button id="cancelDeleteBtn" class="bg-gray-300 text-[#053830] px-4 py-2 rounded-xl hover:bg-gray-400 transition-all">Cancel</button>
      </div>
    </div>
  </div>

  <!-- Message Box -->
  <div id="message-box" class="hidden fixed top-6 left-1/2 transform -translate-x-1/2 px-6 py-3 rounded-xl text-white font-semibold shadow-lg z-50"></div>

  <script>
    // store job id that will be deleted
    let jobToDelete = null;

    // get csrf cookie (Django default name: csrftoken)
    function getCookie(name) {
      let cookieValue = null;
      if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
          const cookie = cookies[i].trim();
          if (cookie.substring(0, name.length + 1) === (name + '=')) {
            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
            break;
          }
        }
      }
      return cookieValue;
    }

    // open confirmation overlay
    function confirmDelete(jobId) {
      jobToDelete = jobId;
      const overlay = document.getElementById('overlay');
      if (overlay) overlay.classList.remove('hidden');
    }

    // wire buttons after DOM ready
    document.addEventListener('DOMContentLoaded', () => {
      const cancelBtn = document.getElementById('cancelDeleteBtn');
      const confirmBtn = document.getElementById('confirmDeleteBtn');

      if (cancelBtn) {
        cancelBtn.addEventListener('click', () => {
          jobToDelete = null;
          document.getElementById('overlay').classList.add('hidden');
        });
      }

      if (confirmBtn) {
        confirmBtn.addEventListener('click', () => {
          if (!jobToDelete) return;
          document.getElementById('overlay').classList.add('hidden');

          // send POST to your delete endpoint (adjust URL if needed)
          fetch(/dashboard/manage-jobs/delete/${jobToDelete}/, {
            method: 'POST',
            headers: {
              'X-CSRFToken': getCookie('csrftoken'),
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({ id: jobToDelete })
          })
          .then(response => response.json())
          .then(data => {
            if (data.success) {
              const row = document.getElementById(`job-row-${jobToDelete}`);
              if (row) {
                // smooth fade-out then remove
                row.style.transition = "opacity 0.4s ease, transform 0.4s ease";
                row.style.opacity = "0";
                row.style.transform = "translateY(-6px)";
                setTimeout(() => row.remove(), 420);
              }
              showMessage('✅ Job deleted successfully!', 'bg-green-600');
            } else {
              showMessage('❌ ' + (data.message || 'Error occurred while deleting.'), 'bg-red-600');
            }
            jobToDelete = null;
          })
          .catch(() => {
            showMessage('An error occurred while deleting.', 'bg-red-600');
            jobToDelete = null;
          });
        });
      }
    });

    // reusable toast message
    function showMessage(message, colorClass) {
      const box = document.getElementById('message-box');
      if (!box) return;
      box.textContent = message;
      box.className = `fixed top-6 left-1/2 transform -translate-x-1/2 px-6 py-3 rounded-xl text-white font-semibold shadow-lg z-50 ${colorClass}`;
      box.classList.remove('hidden');
      setTimeout(() => {
        box.classList.add('hidden');
      }, 2500);
    }
  </script>


<script>
    setTimeout(() => {
        const msg = document.getElementById("flash-msg-box");
        if (msg) {
            msg.style.transition = "opacity 0.5s";
            msg.style.opacity = "0";

            setTimeout(() => msg.style.display = "none", 500);
        }
    }, 2000); // Hide after 1 second
    
</script>
<script>
  document.querySelectorAll(".limit-field").forEach(input => {
    const limit = parseInt(input.dataset.limit);

    input.addEventListener("input", () => {
      if (input.value.length > limit) {
        input.value = input.value.substring(0, limit); // block extra typing
      }

      // update counter
      const counterId = input.id + "-count";
      const counter = document.getElementById(counterId);
      if (counter) counter.textContent = input.value.length;
    });
  });
</script>
<script>
  document.addEventListener("DOMContentLoaded", () => {
      document.getElementById("blur-loader").classList.remove("hidden");
  });

  window.addEventListener("load", () => {
      document.getElementById("blur-loader").classList.add("hidden");
  });

  const jobForm = document.getElementById("jobForm");

  if (!jobForm) {
      console.error("❌ jobForm not found — add id='jobForm' to the form.");
  }

  if (jobForm) {
      jobForm.addEventListener("submit", () => {
          document.getElementById("blur-loader").classList.remove("hidden");
      });
  }
</script>




</body>
</html>