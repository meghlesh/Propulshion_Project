{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Manage Portfolio | Propulsion Technology</title>
  <link rel="icon" type="image/png" href="{% static 'img/logo6.png'%}">
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-[#EAF4E0] font-sans text-[#053830]">

<!-- Blur Loader -->
<div id="blur-loader" class="fixed inset-0 flex items-center justify-center bg-white/60 backdrop-blur-md z-[9999] hidden">
  <div class="w-16 h-16 border-4 border-[#053830] border-t-transparent rounded-full animate-spin"></div>
</div>

<nav class="bg-[#053830] text-white p-5 flex justify-between items-center shadow-lg">
  <h1 class="text-2xl font-bold">Manage Portfolio</h1>
  <div>
    <a href="{% url 'home' %}" class="text-[#FF9728] font-semibold hover:text-[#FFB857] mr-6">Back To Home</a>
    <a href="{% url 'admin_dashboard' %}" class="text-[#FF9728] font-semibold hover:text-[#FFB857] mr-6">Dashboard</a>
    <a href="{% url 'admin_logout' %}" class="bg-[#FF9728] text-[#053830] px-5 py-1.5 rounded-xl font-semibold hover:bg-[#FFB857]">Logout</a>
  </div>
</nav>

<main class="max-w-6xl mx-auto mt-10 p-6 bg-white rounded-3xl shadow-2xl">
  <h2 class="text-3xl font-extrabold mb-6 text-center text-[#053830]">Manage Portfolio</h2>

{% if messages %}
<div id="flash-message-wrapper">
  {% for message in messages %}
    {% if "deleted" in message.message|lower %}
      <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-xl mb-6 shadow-md">{{ message }}</div>
    {% else %}
      <div class="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded-xl mb-6 shadow-md">✅ {{ message }}</div>
    {% endif %}
  {% endfor %}
</div>
{% endif %}

<!-- TABLE -->
<div class="overflow-x-auto mb-6">
  <table class="min-w-full border border-gray-200 rounded-xl overflow-hidden shadow-lg">
    <thead class="bg-[#053830] text-white">
      <tr>
        <th class="px-6 py-3">Title</th>
        <th class="px-6 py-3">Category</th>
        <th class="px-6 py-3">Description</th>
        <th class="px-6 py-3">Order</th>
        <th class="px-6 py-3 text-center">Actions</th>
      </tr>
    </thead>
    <tbody class="divide-y divide-gray-200">
      {% for item in portfolios %}
      <tr class="hover:bg-[#EAF4E0] transition-all">
        <td class="px-6 py-3 font-semibold">{{ item.title }}</td>
        <td class="px-6 py-3">{{ item.category }}</td>
        <td class="px-6 py-3">{{ item.description|truncatechars:60 }}</td>
        <td class="px-6 py-3">{{ item.order }}</td>
        <td class="px-6 py-3 text-center">
          <a href="{% url 'edit_portfolio' item.id %}" class="text-blue-600 hover:text-blue-800 font-semibold">Edit</a>
          <span class="text-gray-400">|</span>
          <a href="{% url 'delete_portfolio' item.id %}" class="text-red-600 hover:text-red-800 font-semibold">Delete</a>
        </td>
      </tr>
      {% empty %}
      <tr>
        <td colspan="5" class="text-center py-6 text-gray-500">No portfolio items yet.</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<!-- FORM -->
<div class="bg-[#EAF4E0] p-8 rounded-2xl shadow-inner mt-8">
  <h3 class="text-2xl font-bold mb-6 text-[#053830]">Add New Portfolio Item</h3>

  <form method="POST" enctype="multipart/form-data" class="space-y-6" id="portfolio-form" novalidate>
    {% csrf_token %}

    <div class="grid md:grid-cols-2 gap-6">
      <div>
        <label class="font-semibold">Title <span class="text-red-600">*</span></label>
        <input id="title" type="text" name="title" required maxlength="50" class="w-full border rounded-xl px-4 py-2" aria-describedby="title-counter title-error">
        <p id="title-counter" class="text-sm mt-1"></p>
        <p id="title-error" class="text-red-600 text-sm mt-1 hidden" aria-live="polite"></p>
      </div>

      <div>
        <label class="font-semibold">Category<span class="text-red-600">*</span></label>
        <input id="category" type="text" name="category" required maxlength="50" class="w-full border rounded-xl px-4 py-2" aria-describedby="category-counter category-error">
        <p id="category-counter" class="text-sm mt-1"></p>
        <p id="category-error" class="text-red-600 text-sm mt-1 hidden" aria-live="polite"></p>
      </div>
    </div>

    <div>
      <label class="font-semibold">Description<span class="text-red-600">*</span></label>
      <textarea id="description" name="description" rows="3" required maxlength="250" class="w-full border rounded-xl px-4 py-2" aria-describedby="description-counter description-error"></textarea>
      <p id="description-counter" class="text-sm mt-1"></p>
      <p id="description-error" class="text-red-600 text-sm mt-1 hidden" aria-live="polite"></p>
    </div>

<!-- IMAGE INPUT -->
<div>
  <label class="font-semibold">Image<span class="text-red-600">*</span></label>
  <input id="image" type="file" name="image" accept=".jpg,.jpeg,.png,.gif" required class="w-full border rounded-xl px-4 py-2 bg-white" aria-describedby="portfolio-file-name image-error">
  <p id="portfolio-file-name" class="text-sm"></p>
  <p id="image-error" class="text-red-600 text-sm mt-1 hidden" aria-live="polite"></p>
  <p class="text-gray-500 text-xs mt-1">Allowed formats: JPG, JPEG, PNG (Max 5 MB)</p>

  <div id="image-preview-container" class="mt-4 hidden">
    <img id="image-preview" class="h-36 rounded-xl shadow border object-cover" alt="Selected image preview">
    <button id="remove-image-btn" type="button" class="bg-red-600 text-white text-xs px-2 py-1 rounded-md mt-2">Remove</button>
  </div>
</div>

    <div>
  <label for="order" class="block font-semibold mb-2">Order<span class="text-red-600">*</span></label>
  <input
    type="number"
    id="order"
    name="order"
    min="0"
    max="9999"
    value="{{ form_values.order|default:0 }}"
    required
    class="w-full border border-gray-300 rounded-xl px-4 py-2 focus:ring-2 focus:ring-[#053830] focus:border-[#053830] transition-all"
    oninput="validateOrder(this)"
    aria-describedby="orderError"
  />
  <p id="orderError" class="text-red-600 text-sm mt-1 hidden" aria-live="polite"></p>
</div>

    <div class="flex justify-center">
      <button id="submit-btn" type="submit" class="bg-[#053830] text-white px-8 py-3 rounded-xl hover:bg-[#FF9728] hover:text-[#053830] transition-all shadow-lg">
        Add Portfolio
      </button>
    </div>
  </form>
</div>
</main>

<script>
/* Character Limit + Hard Stop */
function bindCounter(inputId, counterId, max) {
  const input = document.getElementById(inputId);
  const counter = document.getElementById(counterId);
  if (!input || !counter) return;

  function update(e) {
    let val = input.value || "";

    // prevent further insertion beyond maxlength when typed
    if (e && e.inputType === 'insertText' && val.length >= max) {
      e.preventDefault && e.preventDefault();
      return;
    }

    if (val.length > max) input.value = val.slice(0, max);
    counter.textContent = `${input.value.length} / ${max}`;
    counter.classList.toggle("text-red-600", input.value.length >= max);
  }

  input.addEventListener("beforeinput", update);
  input.addEventListener("input", update);
  update();
}

// Apply limits
bindCounter("title", "title-counter", 50);
bindCounter("category", "category-counter", 50);
bindCounter("description", "description-counter", 250);
</script>

<script>
/* Image Validation + Preview */
const imageInput = document.getElementById("image");
const fileNameEl = document.getElementById("portfolio-file-name");
const errorEl = document.getElementById("image-error");
const previewContainer = document.getElementById("image-preview-container");
const previewImage = document.getElementById("image-preview");
const removeBtn = document.getElementById("remove-image-btn");

let imageValid = true; // stop submission if false

imageInput.addEventListener("change", function () {
  const file = this.files[0];
  const validTypes = ["image/jpeg", "image/png", "image/gif", "image/jpg"];
  const maxSizeMB = 5;

  imageValid = true;
  errorEl.classList.add("hidden");
  previewContainer.classList.add("hidden");
  previewImage.src = "";
  fileNameEl.textContent = "";

  if (!file) return;

  if (!validTypes.includes(file.type)) {
    errorEl.textContent = "❌ Invalid file type. Upload JPG, PNG or GIF.";
    errorEl.classList.remove("hidden");
    imageValid = false;
    this.value = "";
    return;
  }

  const sizeMB = file.size / (1024 * 1024);
  if (sizeMB > maxSizeMB) {
    errorEl.textContent = `❌ File too large (${sizeMB.toFixed(2)}MB). Max 5MB allowed.`;
    errorEl.classList.remove("hidden");
    imageValid = false;
    this.value = "";
    return;
  }

  fileNameEl.textContent = `Selected: ${file.name}`;
  const reader = new FileReader();
  reader.onload = e => {
    previewImage.src = e.target.result;
    previewContainer.classList.remove("hidden");
  };
  reader.readAsDataURL(file);
});

removeBtn.addEventListener("click", () => {
  imageInput.value = "";
  previewImage.src = "";
  previewContainer.classList.add("hidden");
  fileNameEl.textContent = "";
  errorEl.classList.add("hidden");
  imageValid = true;
});

function validateOrder(input) {
    const errorMsg = document.getElementById("orderError");

    // if more than 4 digits, trim and show error
    if (input.value && input.value.length > 4) {
      input.value = input.value.slice(0, 4);
      errorMsg.innerText = "Order can have maximum 4 digits.";
      errorMsg.classList.remove("hidden");
    } else {
      errorMsg.classList.add("hidden");
    }

    // if negative value
    if (input.value < 0) {
      input.value = 0;
      errorMsg.innerText = "Order cannot be negative.";
      errorMsg.classList.remove("hidden");
    }
  }

</script>

<script>
  // Loader + validation on submit
  function showError(id, message) {
    const el = document.getElementById(id + '-error');
    if (!el) return;
    el.textContent = message;
    el.classList.remove('hidden');
  }
  function clearError(id) {
    const el = document.getElementById(id + '-error');
    if (!el) return;
    el.textContent = '';
    el.classList.add('hidden');
  }
  function clearAllErrors() {
    ['title','category','description','image','order'].forEach(clearError);
    const imageErr = document.getElementById('image-error');
    if (imageErr) imageErr.classList.add('hidden');
  }

  const form = document.getElementById('portfolio-form');
  const blurLoader = document.getElementById('blur-loader');

  // Show loader while page resources are loading
  document.addEventListener("DOMContentLoaded", () => blurLoader.classList.remove("hidden"));
  window.addEventListener("load", () => blurLoader.classList.add("hidden"));

  form.addEventListener('submit', function(e) {
    e.preventDefault();
    clearAllErrors();

    const title = document.getElementById('title').value.trim();
    const category = document.getElementById('category').value.trim();
    const description = document.getElementById('description').value.trim();
    const orderInput = document.getElementById('order');
    const orderVal = orderInput.value === '' ? null : parseInt(orderInput.value, 10);
    const file = document.getElementById('image').files[0];

    let valid = true;

    if (!title) { showError('title', 'Title is required.'); valid = false; }
    if (!category) { showError('category', 'Category is required.'); valid = false; }
    if (!description) { showError('description', 'Description is required.'); valid = false; }

    if (orderVal === null || Number.isNaN(orderVal)) {
      showError('order', 'Order is required.');
      valid = false;
    } else if (orderVal < 0) {
      showError('order', 'Order cannot be negative.');
      valid = false;
    } else if (orderVal > 9999) {
      showError('order', 'Order must be <= 9999.');
      valid = false;
    }

    if (!file) {
      showError('image', 'Image is required.');
      valid = false;
    } else if (!imageValid) {
      const imageErr = document.getElementById('image-error');
      if (!imageErr || imageErr.classList.contains('hidden')) {
        showError('image', 'Selected image is invalid (type/size).');
      }
      valid = false;
    }

    if (!valid) {
      blurLoader.classList.add('hidden');
      return false;
    }

    // final check with HTML5 validity (in case browser supports it)
    if (!form.checkValidity()) {
      blurLoader.classList.add('hidden');
      return false;
    }

    // all good → show loader and submit
    blurLoader.classList.remove('hidden');
    form.submit();
  });

  // flash hide
  setTimeout(() => {
    const box = document.getElementById("flash-message-wrapper");
    if (box) box.style.display = "none";
  }, 2000);
</script>

</body>
</html>
